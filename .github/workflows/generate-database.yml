name: Generate ROM Database

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    defaults:
      run:
        working-directory: db

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: db/requirements.txt

      - name: Cache scraped data
        uses: actions/cache@v4
        with:
          path: |
            db/cache
            db/data
          key: scraper-cache-${{ github.run_number }}
          restore-keys: |
            scraper-cache-

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Install Playwright browsers
        run: playwright install chromium

      - name: Create Internet Archive credentials
        env:
          IA_USERNAME: ${{ secrets.IA_USERNAME }}
          IA_PASSWORD: ${{ secrets.IA_PASSWORD }}
        run: |
          if [ -n "$IA_USERNAME" ]; then
            python -c "import json,os; json.dump({'username':os.environ['IA_USERNAME'],'password':os.environ['IA_PASSWORD']}, open('scrapers/internet_archive_creds.json','w'))"
          fi

      - name: Run database generation workflow
        run: python workflow.py --use-cached

      - name: Compress database
        run: gzip -f -k romdb.db

      - name: Get database stats
        id: stats
        run: |
          DB_SIZE=$(stat -c%s romdb.db)
          GZ_SIZE=$(stat -c%s romdb.db.gz)
          ENTRY_COUNT=$(sqlite3 romdb.db "SELECT COUNT(*) FROM entries")
          LINK_COUNT=$(sqlite3 romdb.db "SELECT COUNT(*) FROM links")
          PLATFORM_COUNT=$(sqlite3 romdb.db "SELECT COUNT(DISTINCT platform) FROM entries")
          echo "db_size=$DB_SIZE" >> $GITHUB_OUTPUT
          echo "gz_size=$GZ_SIZE" >> $GITHUB_OUTPUT
          echo "entry_count=$ENTRY_COUNT" >> $GITHUB_OUTPUT
          echo "link_count=$LINK_COUNT" >> $GITHUB_OUTPUT
          echo "platform_count=$PLATFORM_COUNT" >> $GITHUB_OUTPUT

      - name: Create version.json
        run: |
          cat > version.json << EOF
          {
            "version": "$(date +%Y%m%d)",
            "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "size": ${{ steps.stats.outputs.gz_size }},
            "uncompressed_size": ${{ steps.stats.outputs.db_size }},
            "entries": ${{ steps.stats.outputs.entry_count }},
            "links": ${{ steps.stats.outputs.link_count }},
            "platforms": ${{ steps.stats.outputs.platform_count }}
          }
          EOF

      - name: Commit database to repository
        working-directory: .
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add db/romdb.db.gz db/version.json
          git commit -m "Update database $(date +%Y%m%d) - ${{ steps.stats.outputs.entry_count }} entries" || exit 0
          git push
